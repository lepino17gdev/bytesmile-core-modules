<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ByteSmile - Accept Invitation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  >
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

  <div class="container mt-5">
    <div class="card shadow-lg mx-auto" style="max-width: 500px;">
      <div class="card-body">
        <h4 class="text-center mb-4">Accept Your Invitation</h4>
        <h5 class="text-center mb-4">Powered by ByteSmile</h5>

        <div id="invite-status" class="alert alert-info text-center">
          Verifying your invitation...
        </div>

        <form id="accept-form" class="d-none">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" class="form-control" readonly>
          </div>

          <div class="form-group">
            <label>Role</label>
            <input type="text" id="role" class="form-control" readonly>
          </div>

          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="password" class="form-control" required>
          </div>

          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="confirm-password" class="form-control" required>
          </div>

          <button type="submit" class="btn btn-primary btn-block">Create Account</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/staff_invites";
    const token = new URLSearchParams(window.location.search).get("token");

    $(document).ready(() => {
      if (!token) {
        $("#invite-status")
          .removeClass("alert-info")
          .addClass("alert-danger")
          .text("Invalid or missing token.");
        return;
      }

      // Verify token
      $.get(`${API_BASE}/verify?token=${token}`)
        .done(res => {
          $("#invite-status").hide();
          $("#accept-form").removeClass("d-none");
          $("#email").val(res.email);
          $("#role").val(res.role);
        })
        .fail(err => {
          $("#invite-status")
            .removeClass("alert-info")
            .addClass("alert-danger")
            .text(err.responseJSON?.detail || "Invalid or expired invitation.");
        });

      // Accept invite
      $("#accept-form").on("submit", e => {
        e.preventDefault();
        const password = $("#password").val();
        const confirm = $("#confirm-password").val();
        
        console.log( password, token);

        if (password !== confirm) {
          alert("Passwords do not match!");
          return;
        }

        $.ajax({
          url: `${API_BASE}/accept`,
          type: "POST",
          data: { "token": token, "password": password },
          success: res => {
            console.log(res)
            if( res.message )
              alert(res.message);
            else
              alert(res);
            window.location.href = "/login"; // redirect to login page
          },
          error: err => {
            console.log(err)
            alert(err.responseJSON?.detail[0].msg || "Error accepting invitation.");
          }
        });
      });

      
    });
  </script>

</body>
</html>
