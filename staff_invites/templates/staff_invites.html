{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold text-primary mb-0"><i class="bi bi-envelope-plus me-2"></i>Manage Staff Invites</h3>
    <!-- Button that triggers modal -->
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
      <i class="bi bi-plus-circle"></i> New Invite
    </button>
  </div>

  <!-- Modal Triggered via data attributes -->
  <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content text-primary">
        <form id="inviteForm">
          <div class="modal-header">
            <h5 class="modal-title" id="inviteModalLabel">Create New Invite</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="inviteEmail" class="form-label">Email</label>
              <input type="email" id="inviteEmail" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="inviteRole" class="form-label">Role</label>
              <select id="inviteRole" class="form-select" required>
                <option value="">Select role</option>
                <option value="staff">Staff</option>
                <option value="dentist">Dentist</option>
                <option value="manager">Manager</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Send Invite</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Invites Table -->
  <div class="card shadow-sm border-0 mt-3">
    <div class="card-body">
      <h5 class="card-title fw-bold text-primary">Active Invites</h5>
      <div class="table-responsive">
        <table class="table table-hover align-middle text-nowrap">
          <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Created</th>
              <th>Expires</th>
              <th>Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="inviteTableBody">
            <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Load existing staff_invites
  async function loadInvites() {
    const res = await fetch("/api/staff_invites/list");
    const table = document.getElementById("inviteTableBody");
    table.innerHTML = "";
    if (res.ok) {
      const data = await res.json();
      if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No Staff Invites found.</td></tr>`;
        return;
      }
      data.forEach(invite => {
        const status = invite.accepted
          ? `<span class="badge bg-success">Accepted</span>`
          : invite.expired
            ? `<span class="badge bg-secondary">Expired</span>`
            : `<span class="badge bg-warning text-dark">Pending</span>`;
        const row = `
          <tr>
            <td>${invite.email}</td>
            <td>${invite.role}</td>
            <td>${invite.created_at}</td>
            <td>${invite.expires_at}</td>
            <td>${status}</td>
            <td>
              ${!invite.accepted && !invite.expired
                ? `<button class="btn btn-sm btn-outline-danger" onclick="revokeInvite('${invite.token}')">Revoke</button>`
                : ""}
            </td>
          </tr>`;
        table.insertAdjacentHTML("beforeend", row);
      });
    } else {
      table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load Staff Invites.</td></tr>`;
    }
  }

  // Create new invite
  document.getElementById("inviteForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("inviteEmail").value;
    const role = document.getElementById("inviteRole").value;
    const res = await fetch("/api/staff_invites/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, role })
    });
    if (res.ok) {
      alert("Invite sent successfully!");
      document.getElementById("inviteForm").reset();
      const modalEl = document.getElementById("inviteModal");
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      modalInstance.hide();
      loadInvites();
    } else {
      const err = await res.json();
      alert("Error: " + err.detail);
    }
  });

  // Revoke invite
  async function revokeInvite(token) {
    if (!confirm("Are you sure you want to revoke this invite?")) return;
    const res = await fetch(`/api/staff_invites/revoke?token=${token}`, { method: "DELETE" });
    if (res.ok) {
      alert("Invite revoked successfully.");
      loadInvites();
    } else {
      alert("Failed to revoke invite.");
    }
  }

  document.addEventListener("DOMContentLoaded", loadInvites);
</script>
{% endblock %}
