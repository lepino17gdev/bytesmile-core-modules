{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h3 class="fw-bold mb-0">Access Matrix</h3>
    <div class="text-muted small">Role-based & user-based permissions to modules</div>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#grantModal">
    <i class="bi bi-plus-lg me-1"></i> New Permission
  </button>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body"> 
    <div class="row g-3 align-items-end access-toolbar">
      <div class="col-md-3">
        <label class="form-label">Filter by Subject</label>
        <select id="filterSubject" class="form-select">
          <option value="all" selected>All (Roles & Users)</option>
          <option value="role">Roles only</option>
          <option value="user">Users only</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Filter by Module</label>
        <input id="filterModule" class="form-control" placeholder="e.g. appointments, invites">
      </div>
      <div class="col-md-3">
        <label class="form-label">Filter by Permission</label>
        <select id="filterPermission" class="form-select">
          <option value="all" selected>All</option>
          <option value="view">view</option>
          <option value="create">create</option>
          <option value="edit">edit</option>
          <option value="delete">delete</option>
          <option value="manage">manage</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Search</label>
        <input id="filterSearch" class="form-control" placeholder="name, email, role…">
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table align-middle access-table">
        <thead class="table-light">
          <tr>
            <th style="min-width: 160px;">Subject</th>
            <th style="min-width: 120px;">Type</th>
            <th style="min-width: 160px;">Module</th>
            <th style="min-width: 140px;">Permission</th>
            <th class="text-end" style="min-width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="accessRows">
          <!-- populated by JS -->
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
      <div class="small text-muted" id="accessCount">0 items</div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="prevPage">Prev</button>
        <span class="small" id="pageInfo">Page 1 / 1</span>
        <button class="btn btn-sm btn-outline-secondary" id="nextPage">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Grant Permission Modal -->
<div class="modal fade" id="grantModal" tabindex="-1" aria-labelledby="grantModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="grantForm">
        <div class="modal-header">
          <h5 class="modal-title" id="grantModalLabel">Grant Permission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Subject Type</label>
              <select class="form-select" id="subjectType" required>
                <option value="role" selected>Role</option>
                <option value="user">User</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label">Subject (Role name or User email)</label>
              <input id="subjectValue" class="form-control" placeholder="e.g. manager or user@example.com" required>
              <div class="form-text">We will resolve to role_id or user_id on submit.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Module</label>
              <input id="moduleSlug" class="form-control" placeholder="e.g. invites, appointments" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Permission</label>
              <select id="permission" class="form-select" required>
                <option value="view" selected>view</option>
                <option value="create">create</option>
                <option value="edit">edit</option>
                <option value="delete">delete</option>
                <option value="manage">manage</option>
              </select>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2 me-1"></i> Grant
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="container mt-4">
  <h2>{{ title }}</h2>
  <hr>

  <div class="mb-3">
    <label>Role ID</label>
    <input type="number" id="role_id" class="form-control" placeholder="Role ID">

    <label>User ID</label>
    <input type="number" id="user_id" class="form-control" placeholder="Optional User ID">

    <label>Module</label>
    <input type="text" id="module" class="form-control" placeholder="e.g. clinic, billing">

    <label>Permission</label>
    <input type="text" id="permission" class="form-control" placeholder="e.g. view, edit">

    <button class="btn btn-success mt-2" onclick="addAccess()">➕ Add Access</button>
  </div>

  <table class="table table-striped mt-4" id="accessTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Role ID</th>
        <th>User ID</th>
        <th>Module</th>
        <th>Permission</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="/static/js/access_matrix.js"></script>
{% endblock %}

{% block extra_js %}
<script src="/static/js/access_matrix.js"></script>
{% endblock %}
